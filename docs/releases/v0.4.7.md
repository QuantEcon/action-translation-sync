# Release v0.4.7 - Full Recursive Heading Support

**Release Date**: October 24, 2025  
**Status**: Production-Ready ✅  
**Type**: Critical Bug Fix + Enhancement

---

## Overview

v0.4.7 implements full recursive heading support for all MyST Markdown heading levels (##, ###, ####, #####, ######), fixing a critical bug where changes to sub-subsections and deeper nesting were not detected, causing incomplete translations.

**Critical Fix**: GitHub Test 10 revealed that adding a `#### Closure Property` sub-subsection to a `### Basic Properties` subsection was not detected, resulting in no translation. This release completely resolves the issue with a robust recursive solution.

---

## The Problem

### Symptoms
- Changes to `####` (sub-subsections) and deeper levels were silently ignored
- Diff detector reported `UNCHANGED` even when content was added
- Translations incomplete for documents with nested structure
- Test 10 failed: sub-subsection addition not detected

### Root Cause
1. **Parser**: Only handled `##` (sections) and `###` (subsections) explicitly
2. **Diff Detector**: Only compared section-level content, ignoring nested subsections recursively
3. **Result**: Changes within `###` subsections were not propagated to parent section comparison

Example failure:
```markdown
## Vector Spaces
  ### Basic Properties
    #### Applications in Economics  (already exists)
    #### Closure Property          (NEW - added) ❌ Not detected!
```

---

## The Solution

### 1. Parser Refactoring (src/parser.ts)

**Before** - Hardcoded levels:
```typescript
// Check for ## heading
const h2Match = line.match(/^##\s+(.+)$/);
if (h2Match) { ... }

// Check for ### heading  
const h3Match = line.match(/^###\s+(.+)$/);
if (h3Match) { ... }
```

**After** - Stack-based recursion:
```typescript
// Check for any heading level (## through ######)
const headingMatch = line.match(/^(#{2,6})\s+(.+)$/);
if (headingMatch) {
  const level = headingMatch[1].length;  // 2, 3, 4, 5, or 6
  // Stack-based handling for arbitrary depth
}
```

**Benefits**:
- Handles all MyST heading levels (2-6)
- Arbitrary nesting depth supported
- Truly recursive `Section.subsections` structure
- ~80 lines of code (down from ~120)

### 2. Diff Detector Enhancement (src/diff-detector.ts)

**Before** - Flat comparison:
```typescript
private sectionContentEqual(s1: Section, s2: Section): boolean {
  return s1.content.trim() === s2.content.trim();
}
```

**After** - Recursive comparison:
```typescript
private sectionContentEqual(s1: Section, s2: Section): boolean {
  // 1. Compare direct content
  if (s1.content.trim() !== s2.content.trim()) return false;
  
  // 2. Compare subsection count
  if (s1.subsections.length !== s2.subsections.length) return false;
  
  // 3. Recursively compare each subsection
  for (let i = 0; i < s1.subsections.length; i++) {
    if (!this.sectionContentEqual(s1.subsections[i], s2.subsections[i])) {
      return false;
    }
  }
  
  return true;
}
```

**Benefits**:
- Detects changes at any nesting depth
- Count and content comparison at each level
- Handles arbitrarily nested structures

### 3. File Processor Fixes (src/file-processor.ts)

**Issue**: When sections were modified and translated, the heading from the translation (English in TEST mode) was used instead of preserving the Chinese heading from the target.

**Fix**:
```typescript
// Extract heading from target section (Chinese) and body from translated content
let finalContent = contentWithoutSubsections || targetSection.content;
if (contentWithoutSubsections) {
  const translatedLines = contentWithoutSubsections.split('\n');
  const bodyLines = translatedLines.slice(1);  // Skip translated heading
  finalContent = `${targetSection.heading}\n${bodyLines.join('\n')}`;  // Use target heading!
}

// Preserve target subsections if translator doesn't return full structure (TEST mode)
const finalSubsections = subsections.length > 0 ? subsections : targetSection.subsections;
```

---

## What's New

### Features
✅ **Full Recursive Parsing**: All heading levels (##-######) supported with arbitrary nesting  
✅ **Recursive Change Detection**: Detects modifications at any depth  
✅ **Preserved Target Headings**: Chinese headings maintained during translation updates  
✅ **Preserved Target Subsections**: Subsection structure maintained when translator returns simplified content

### Test Coverage
✅ **6 New Tests** for nested subsection detection:
- `should detect #### sub-subsection added to ### subsection`
- `should detect #### content modification within ### subsection`
- `should detect ##### deeply nested changes`
- `should detect multiple #### subsections added`
- `should handle mixed depth changes (#### added, ### modified)`
- `should NOT detect change when #### content unchanged`

✅ **Total**: 131 tests passing (125 original + 6 new)

### GitHub Validation
✅ **Test 10** now passes:
```
[DiffDetector] MODIFIED: Section "## Vector Spaces"
[DiffDetector] Total section changes detected: 1
[Translator] Translating section update, mode=update
Created PR: https://github.com/QuantEcon/test-translation-sync.zh-cn/pull/193
```

---

## Technical Details

### Parser Algorithm

**Stack-Based Approach**:
1. Maintain stack of currently open sections at each level
2. When new heading encountered:
   - Pop stack until parent level found
   - Push completed sections to their parents
   - Push new section onto stack
3. At end, unwind stack to complete all sections

**Advantages**:
- O(n) time complexity (single pass)
- O(d) space complexity where d = max depth
- Naturally handles arbitrary nesting
- No recursion in parsing (just in structure)

### Comparison Algorithm

**Recursive Descent**:
1. Compare direct content (without subsections)
2. Check subsection counts match
3. Recursively compare each subsection pair
4. Short-circuit on first difference

**Advantages**:
- Detects changes at any depth
- Clear separation of concerns
- Easy to reason about
- Efficient (stops at first diff)

---

## Migration Guide

**No Breaking Changes** - This release is fully backward compatible.

### For Users
- **No action required** - Documents will automatically benefit from improved change detection
- Deeply nested structures now fully supported
- More accurate translations for complex documents

### For Developers
- Parser API unchanged
- `Section` interface unchanged (already had recursive `subsections`)
- Diff detector API unchanged
- All existing tests continue to pass

---

## Performance

- **Bundle Size**: 1937kB (was 1935kB, +2kB)
- **Build Time**: 884ms
- **Test Suite**: 131 tests in ~2.8s
- **Parsing Speed**: ~1000 lines/ms (unchanged)

---

## Known Issues

None identified. This release resolves the critical Test 10 bug.

---

## Commits

- `d36eadd` - feat: implement full recursive heading support (##-######)

**Changes**:
- `src/parser.ts`: Stack-based recursive parsing (~80 lines, -40 LOC)
- `src/diff-detector.ts`: Recursive section comparison (+15 LOC)
- `src/file-processor.ts`: Preserve target headings and subsections (+15 LOC)
- `src/__tests__/diff-detector.test.ts`: 6 new nested subsection tests (+180 LOC)
- `src/__tests__/e2e-fixtures.test.ts`: Updated test expectations (+2 LOC)

**Total**: +172 LOC added, -40 LOC removed, net +132 LOC

---

## What's Next

### v0.4.8 Candidates
- Performance optimization for very large documents
- Additional edge case testing

### v1.0 Preparation
- API stabilization review
- Production validation period (2-4 weeks)
- Final documentation polish

---

## Credits

**Issue Identified**: GitHub Test 10 - "TEST: Sub-subsection added (####)"  
**Resolution**: Full recursive heading support implementation  
**Validation**: All 131 tests passing + GitHub test confirmation

---

**Full Changelog**: https://github.com/QuantEcon/action-translation-sync/compare/v0.4.6...v0.4.7
