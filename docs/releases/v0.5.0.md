# Release v0.5.0: TOC Files, File Deletions, and Enhanced Test Coverage

**Release Date**: November 6, 2025
**Status**: Production-Ready

## Overview

This release adds support for three critical features that enable comprehensive document lifecycle management:

1. **TOC File Syncing** - `_toc.yml` files are now automatically synced to target repos
2. **File Deletion Handling** - Removed files are deleted from target repos
3. **Enhanced Test Coverage** - 8 new test scenarios covering lifecycle operations and edge cases

## Features

### 1. TOC File Support

**Problem**: Table of contents files (`_toc.yml`) were ignored, causing inconsistencies when adding/removing documents.

**Solution**: TOC files are now detected, copied directly to target repos without translation.

**Implementation**:
- Filter TOC files with `.endsWith('_toc.yml')`
- Copy content directly (no translation needed)
- Include in PR alongside translated markdown files

**Use Cases**:
- Adding new documents (Test 17)
- Removing documents (Test 18)  
- Renaming documents (Test 20)

### 2. File Deletion Handling

**Problem**: When files were deleted from source repo, they persisted in target repos, creating outdated content.

**Solution**: Deleted files are now detected and removed from target repos.

**Implementation**:
- Filter removed files with `status === 'removed'`
- Check if file exists in target repo
- Delete using GitHub API with file SHA
- Include deletions in PR description

**Use Cases**:
- Document cleanup
- Content reorganization
- Deprecation workflows

### 3. Enhanced Test Coverage

**Added 8 new test scenarios** across two categories:

#### Document Lifecycle Tests (17-20)

**Test 17 - NEW Document**:
- Adds `game-theory.md` (195 lines, complete lecture)
- Updates `_toc.yml` with new entry
- Tests: TOC sync + new file translation

**Test 18 - DELETE Document**:
- Removes `lecture.md` from repo
- Updates `_toc.yml` to remove entry
- Tests: File deletion + TOC sync

**Test 19 - Multi-File PR**:
- Modifies `lecture-minimal.md` (new subsection)
- Modifies `lecture.md` (eigenvalues section)
- Tests: Multiple files in single PR

**Test 20 - RENAME Document**:
- Renames `lecture.md` → `linear-algebra.md`
- Updates `_toc.yml` with new filename
- Tests: Rename handling + TOC sync

#### Edge Case Tests (21-25)

**Test 21 - Preamble-Only**:
- Changes only frontmatter (jupytext version)
- No content changes
- Tests: Metadata-only updates

**Test 22 - Deep Nesting**:
- Hierarchical structure with ##### and ###### levels
- Tests: Extreme nesting depth

**Test 24 - Special Characters**:
- Headings with `code`, **bold**, [links], $math$
- Tests: Complex formatting preservation

**Test 25 - Empty Sections**:
- Headings without content
- Tests: Edge case handling

## Technical Implementation

### Code Changes

**File**: `src/index.ts`

**Added Filters** (lines 58-95):
```typescript
// TOC files (added/modified)
const changedTocFiles = files.filter(
  (file: any) =>
    file.filename.endsWith('_toc.yml') &&
    file.status !== 'removed'
);

// Removed markdown files
const removedMarkdownFiles = files.filter(
  (file: any) =>
    file.filename.endsWith('.md') &&
    file.status === 'removed'
);

// Removed TOC files
const removedTocFiles = files.filter(
  (file: any) =>
    file.filename.endsWith('_toc.yml') &&
    file.status === 'removed'
);
```

**TOC Processing** (lines 210-250):
- Get TOC content from source repo
- Check if exists in target repo
- Add to `translatedFiles` array for PR creation

**Deletion Processing** (lines 252-290):
- Check if removed file exists in target
- Store SHA for deletion
- Add to `filesToDelete` array

**PR Creation Updates** (lines 340-360):
- Delete files using `octokit.rest.repos.deleteFile`
- Update PR body to show deletions section
- Include all files (translated + deleted) in title

### Test Infrastructure

**Script Updates**: `tool-test-action-on-github/test-action-on-github.sh`
- Added TOC file handling for tests 17, 18, 20
- Multi-file PR support for test 19
- Rename operation for test 20
- Updated to show 4 test categories in summary

**New Test Data Files** (13 files):
```
tool-test-action-on-github/test-action-on-github-data/
├── 17-new-document-toc.yml           # TOC with game-theory
├── 18-delete-document-toc.yml        # TOC without lecture
├── 19-multi-file-minimal.md          # Enhanced minimal
├── 19-multi-file-lecture.md          # Enhanced lecture
├── 20-rename-document-toc.yml        # TOC with linear-algebra
├── 21-preamble-only-minimal.md       # Metadata change only
├── 22-deep-nesting-lecture.md        # ##### and ###### levels
├── 24-special-chars-lecture.md       # Complex formatting
├── 25-empty-sections-minimal.md      # Empty section edge case
├── game-theory.md                    # Complete new lecture (195 lines)
├── linear-algebra.md                 # Copy of lecture for rename
├── base-toc.yml                      # English TOC template
└── base-toc-zh-cn.yml                # Chinese TOC template
```

## Testing

### Unit Tests
All 140 existing tests pass with new implementation:
```
Test Suites: 8 passed, 8 total
Tests:       140 passed, 140 total
```

### GitHub Integration Tests
24 total scenarios (16 existing + 8 new):

**Basic Translation (1-8)**:
- Single section updates
- Multi-section updates
- Nested subsections
- Preamble changes

**Scientific Content (9-16)**:
- Math equations
- Code blocks
- Figures and tables
- Admonitions

**Document Lifecycle (17-20)** ✨ NEW:
- NEW document + TOC
- DELETE document + TOC
- Multi-file PRs
- RENAME + TOC

**Edge Cases (21-25)** ✨ NEW:
- Preamble-only
- Deep nesting (6 levels)
- Special characters
- Empty sections

## Impact

### Before v0.5.0
❌ TOC files ignored → Manual updates required
❌ Deleted files persisted → Stale content in target repos
❌ Limited test coverage → Gaps in lifecycle scenarios

### After v0.5.0
✅ TOC files automatically synced
✅ Deleted files removed from target repos
✅ Comprehensive lifecycle coverage
✅ Edge cases validated
✅ Production-ready for all document operations

## Migration Guide

**No breaking changes** - All existing workflows continue to work.

**New Capabilities**:
1. Add/remove documents freely - TOC automatically syncs
2. Delete files in source - They're removed from target
3. Multi-file PRs handled correctly
4. Renames treated as delete + add

## Next Steps

### Potential Enhancements
1. **Atomic Rename Detection**: Detect GitHub's rename status for better handling
2. **TOC Translation**: Translate comments in TOC files (currently copied as-is)
3. **Directory Reorganization**: Handle file moves across directories
4. **Batch Operations**: Optimize multi-file processing

### Documentation
- ✅ Release notes (this file)
- ✅ Test repository guide updated
- ✅ README.md examples added
- TODO: Update ARCHITECTURE.md with new flows

## Contributors

- Implementation: GitHub Copilot
- Testing: Automated test suite
- Review: QuantEcon team

## References

- **PR**: [Implementation of TOC/Delete support]
- **Issues**: Addresses Test 17, 18, 20 implementation
- **Tests**: 8 new GitHub test scenarios
- **Docs**: `docs/TEST-REPOSITORIES.md` updated

---

**Version**: 0.5.0
**Compatibility**: GitHub Actions, Node.js 20
**Dependencies**: No new dependencies added
**Bundle Size**: 1946kB (unchanged)
