# Release v0.4.6 - Critical Bug Fixes

**Release Date**: October 24, 2025  
**Type**: Bug Fix Release  
**Status**: Production-Ready ✅

## Overview

v0.4.6 fixes two critical bugs discovered during GitHub test validation:
1. **Section comparison using exact equality** instead of 20% threshold
2. **Branch name collisions** from concurrent PR processing

This release ensures that even subtle content changes (typo fixes, added phrases) are properly detected and translated.

---

## Critical Bug Fixes

### 1. Section Comparison Fix (f40a1f3)

**Problem**: The old `sectionContentEqual` method used a 20% length threshold to determine if section content changed. This missed subtle but important changes.

**Example**: Test 09 (Real-world lecture update)
- English added phrases like ", with updated examples from recent research" (44 chars)
- Section length: ~2000 chars
- Change: 2.2% (below 20% threshold)
- Result: ❌ Marked as UNCHANGED, no translation occurred

**Root Cause**:
```typescript
// OLD - Too lenient
const lengthDiff = Math.abs(section1.content.length - section2.content.length);
const avgLength = (section1.content.length + section2.content.length) / 2;
if (lengthDiff / avgLength > 0.2) {
  return false;  // Different only if >20% change
}
```

**Solution**:
```typescript
// NEW - Exact string equality
private sectionContentEqual(section1: Section, section2: Section): boolean {
  // Compare source documents (old English vs new English) using exact string equality
  // Any change in content, even a single character, should be detected
  return section1.content.trim() === section2.content.trim();
}
```

**Impact**:
- ✅ Detects typo fixes (1 character change)
- ✅ Detects added words and phrases
- ✅ Detects removed content
- ✅ All content changes now trigger translation

**Tests Added**:
- Test for subtle changes (typo fix: "orignal" → "original")
- Test for added phrases (", with updated examples from recent research")

**Files Changed**:
- `src/diff-detector.ts`: Simplified `sectionContentEqual` method
- Removed unused `extractCodeBlocks` method
- `src/__tests__/diff-detector.test.ts`: Added 2 new tests

### 2. Branch Name Collision Fix (71136db)

**Problem**: Multiple PRs processed within the same second created identical branch names, causing "Reference already exists" errors.

**Example**:
- PR #199 creates: `translation-sync-2025-10-24T03-13-42`
- PR #207 creates: `translation-sync-2025-10-24T03-13-42` (same second!)
- Result: ❌ Second PR fails with "Reference already exists"

**Solution**: Include source PR number in branch name
```typescript
// OLD
const branchName = `translation-sync-${timestamp}`;

// NEW
const branchName = `translation-sync-${timestamp}-pr-${prNumber}`;
```

**Impact**:
- ✅ Unique branch name per source PR
- ✅ No more "Reference already exists" errors
- ✅ Supports concurrent PR processing
- ✅ Easier to trace which translation PR came from which source PR

**Example Branch Names**:
- `translation-sync-2025-10-24T03-13-42-pr-199`
- `translation-sync-2025-10-24T03-13-42-pr-207`

**Files Changed**:
- `src/index.ts`: Updated branch name generation (line 231)

---

## Test Suite Enhancements

### New Tests (e78cdeb)

Added comprehensive tests for the section comparison fix:

1. **Subtle content changes test**:
   - Changes "orignal" → "original" (2 characters)
   - Validates even typo fixes are detected

2. **Added phrases test**:
   - Adds ", with updated examples from recent research"
   - Validates editorial improvements are detected

**Test Coverage**:
- **125 tests** (up from 121 in v0.4.5)
- All passing ✅
- Execution time: ~3s

### Test Organization

- **18 tests** in diff-detector.test.ts (was 16)
  - Added: Subtle changes detection
  - Added: Added phrases detection
  
**Files Changed**:
- `src/__tests__/diff-detector.test.ts`: Added 2 regression tests

---

## Other Enhancements

### Test 16: Pure Section Reordering (b6410ae)

Added test case for section reordering with ZERO content changes:
- Swaps "Economic Models" ↔ "Supply and Demand"
- No text changes, only position changes
- Tests position-based section matching

### Enhanced PR Titles (3e0df00)

Test PRs now include test number and file type:
- Old: `TEST: Intro text updated`
- New: `TEST: Intro text updated (01 - minimal)`

### Test Repository Improvements

- Test 04 clarified: "Sections reordered **and content changed**"
- Added Applications sub-subsection to base-lecture.md for test 15
- Corrected tests 10-15 to be properly based on base-lecture.md

---

## Migration Guide

### For Users

**No action required**. Update your workflow to use v0.4.6:

```yaml
- uses: quantecon/action-translation-sync@v0.4.6
```

### For Developers

**No API changes**. The fix is internal to the diff detection logic.

**What Changed**:
- Section comparison now uses exact string equality
- Branch names include source PR number

**What Stayed the Same**:
- All inputs and outputs unchanged
- UPDATE mode and NEW mode work identically
- Heading-map system unchanged
- Subsection handling unchanged

---

## Known Issues

### LLM Improvement Behavior

**Issue**: During UPDATE mode, Claude sometimes improves existing translations beyond what changed in the English source.

**Example**: Test 09 updated English text about "Leontief systems", and Claude also standardized the transliteration in code comments from `里昂惕夫` → `列昂惕夫` (old → modern transliteration).

**Status**: Accepting as beneficial behavior. Tracked in [Issue #1](https://github.com/QuantEcon/action-translation-sync/issues/1).

**Future Options**:
- Add `allow_improvements: true` flag (default: true) if this becomes problematic
- Stricter UPDATE mode prompts
- Continue monitoring (current approach)

---

## Technical Details

### Commits Since v0.4.5

```
e78cdeb test: Add tests for subtle content changes (typo fixes, added phrases)
5457ff8 build: Rebuild action with exact section comparison
f40a1f3 fix: Use exact string equality for source document section comparison
941e495 test: Update test 04 description to clarify it includes content change
2fbc41a build: Rebuild action with PR number in branch name
71136db fix: Include source PR number in target branch name
b6410ae feat: Add test 16 - Pure section reorder (no content change)
79c5d50 fix: Add content change to test 04 (section reorder)
3e0df00 feat: Add test number and file type to PR titles and descriptions
a749bbb fix: Add Applications sub-subsection to base and update all tests
39a17a2 fix: Correct tests 10-15 to be based on base-lecture.md
f0dbf56 test: add 6 new test cases for scientific content translation
3d5a049 test: enhance base documents with Python code cells and math content
```

### Files Changed

**Source Code** (2 files):
- `src/diff-detector.ts` - Section comparison logic
- `src/index.ts` - Branch name generation

**Tests** (1 file):
- `src/__tests__/diff-detector.test.ts` - Added 2 tests

**Distribution** (5 files):
- `dist/index.js` - Rebuilt with fixes
- `dist/index.js.map` - Updated source map
- `dist/sourcemap-register.js` - No change
- `dist/licenses.txt` - No change

**Documentation** (1 file):
- `scripts/test-action-on-github.sh` - Updated test descriptions

### Bundle Size

- **1935 KB** (was 1936 KB in v0.4.5)
- Build time: ~885ms

---

## Testing

### Local Tests
```bash
npm test
```
**Result**: ✅ 125 tests passing

### GitHub Integration Tests
16 test scenarios validated:
- Tests 01-08: Basic structure (lecture-minimal.md)
- Tests 09-15: Scientific content (lecture.md)
- Test 16: Pure section reordering

**All tests passing** with new branch naming and section detection.

---

## Acknowledgments

- **Bug Discovery**: Test 09 investigation revealed section comparison issue
- **Root Cause Analysis**: 20% threshold identified as problematic for subtle changes
- **Solution Design**: Simple string equality for same-language comparison

---

## What's Next

### v0.4.7 (Planned)
- Monitor LLM improvement behavior in production
- Consider `allow_improvements` flag if needed
- Performance optimizations for large documents

### Future Enhancements
- Configurable section comparison strategies
- Enhanced diff visualization in PRs
- Parallel translation for multiple files

---

## Upgrade Checklist

- [x] Update package.json to v0.4.6
- [x] Create release notes
- [x] Update documentation references
- [x] Run all tests (125 passing)
- [x] Rebuild action distribution
- [x] Create GitHub release
- [x] Update copilot-instructions.md
- [x] Validate on GitHub test repository

---

**Version**: 0.4.6  
**Release Date**: October 24, 2025  
**Tested**: ✅ All 125 tests passing  
**Status**: Production-Ready
