# Release v0.4.4 - Developer Experience & Robustness

**Release Date**: October 24, 2025  
**Status**: Production-Ready ‚úÖ  
**Focus**: Root-level file support, GitHub test infrastructure, improved PR quality

---

## Overview

v0.4.4 focuses on developer experience and production robustness. This release adds comprehensive GitHub testing infrastructure, fixes root-level file support, improves PR quality, and includes the final subsection duplication fix discovered during testing.

**Key Achievements**: 
- Root-level file support (`docs-folder: '.'`)
- 9 automated GitHub test scenarios with PR validation
- Improved PR titles and descriptions
- Subsection duplication fix (final piece from v0.4.3 work)
- 34 new tests (121 total, was 87)

---

## What's New

### üêõ Bug Fixes

#### Subsection Duplication Bug (Critical)

**Problem**: Subsections were being duplicated in translated output when `reconstructFromSections()` appended subsections that were already present in `section.content`.

**Root Cause**: `parseTranslatedSubsections()` returned subsections array but didn't strip them from the content. When reconstructing, subsections appeared twice: once in content, once appended from the array.

**Commits**: 
- `9463ca1` - Fix: Prevent duplicate subsections in translated content
- `6678c91` - Add test case for subsection duplication prevention

**Solution**:
```typescript
// file-processor.ts: parseTranslatedSubsections()
// Before (buggy): Returned full content including subsections
return { subsections, contentWithoutSubsections: fullContent };

// After (fixed): Strip subsections from content
const contentWithoutSubsections = lines.slice(0, firstSubsectionLine).join('\n');
return { subsections, contentWithoutSubsections };
```

**Impact**: Documents now reconstruct correctly with no duplication. Test added to prevent regression.

#### Root-Level File Support

**Problem**: Files at repository root (not in subdirectory) weren't being processed.

**GitHub Actions Quirk**: Undocumented behavior converts `docs-folder: '.'` to `docs-folder: '/'`.

**Commits**: `9b68a1b`, `8857bc1`, `3a7c712`, `ede7167`, `217f412`, `95632f6`, `3b91c7d`, `cf26944`

**Solution**:
```typescript
// index.ts: Handle both '.' and '/' as root-level
if (docsFolder === '.' || docsFolder === '/') {
  docsFolder = '';
}

// Skip normalization for empty string (don't add trailing slash)
if (docsFolder && !docsFolder.endsWith('/')) {
  docsFolder = docsFolder + '/';
}

// Filter root-level files (no subdirectories)
if (docsFolder === '') {
  return file.endsWith('.md') && !file.includes('/');
}
```

**Impact**: Now works with `docs-folder: '.'` for root-level files.

#### Test Script Merge Conflicts

**Problem**: Test script was modifying main branch after creating test PRs, causing merge conflicts.

**Commit**: `a6f0d81` - Fix: Don't modify main after creating PRs to avoid merge conflicts

**Solution**: Set up main branch once at start, never modify it during PR creation. All test PRs branch from same commit.

**Impact**: Clean test PRs with no merge conflicts.

#### Cross-Repo Permissions

**Problem**: `GITHUB_TOKEN` doesn't have permissions to create PRs in target repo.

**Commit**: `3113195` - Update workflow template to use QUANTECON_SERVICES_PAT

**Solution**: Use `QUANTECON_SERVICES_PAT` for cross-repo operations.

**Impact**: PRs now create successfully in target repositories.

### ‚ú® Enhancements

#### Improved PR Titles and Descriptions

**Commit**: `280701e` - Improve target repo PR: use filenames in title and hyperlink source PR

**Before**: Generic titles like "Update 1 file(s)"  
**After**: Specific titles with filenames

```typescript
// Examples:
"Update intro.md"                    // 1 file
"Update intro.md, theory.md"         // 2 files
"Update intro.md and 2 other files"  // 3+ files
```

**Also**: Source PR number now hyperlinked in description.

**Impact**: Much better PR readability and navigation.

#### GitHub Test Infrastructure

**Commits**: 
- `a57c99e` - Add TEST mode support and GitHub testing infrastructure
- `a4b2cc6` - Add target repo PR cleanup to test script
- `9265dea` - Remove unnecessary commits to target repo

**Features**:
- 9 automated test scenarios with reset script
- Cross-repo PR creation validated
- TEST mode (no API calls for quick testing)
- Automated cleanup and reset
- Script: `scripts/test-action-on-github.sh`

**Test Scenarios**:
1. New file (full translation)
2. Single section update
3. Multiple section updates
4. Section added
5. Section deleted
6. Preamble update
7. Subsection content update
8. Heading-map integration
9. Root-level file support

**Impact**: Comprehensive validation in real GitHub environment.

#### Component-Based Reconstruction

**Commit**: `a899aea` - refactor: implement component-based document reconstruction

**Purpose**: Cleaner, more maintainable document reconstruction logic.

**Impact**: Better code organization, easier to maintain.

### üìö Documentation

**Commits**:
- `74ed6d2` - DOCS: add presentation on action
- `72b5727` - docs: add test repository setup information to copilot instructions

**New Content**:
- Presentation slides explaining the action
- Test repository setup guide
- Enhanced copilot instructions

### ‚úÖ Testing

**New Tests**: 34 tests added (121 total, all passing)

**Test Breakdown**:
- Parser: 15 tests
- Diff Detector: 15 tests
- File Processor: 54 tests (including duplication regression test)
- Heading-Map: 28 tests (including v0.4.3 subsection tests)
- Integration: 9 tests

**Key Regression Tests**:
- **Subsection duplication prevention** (`file-processor.test.ts:580-616`)
  - Verifies `parseTranslatedSubsections` strips subsections from content
  - Documents fix for GitHub test scenario #103
  
**GitHub Test Infrastructure**:
- 9 test PRs (#97-#105) running successfully
- Automated reset script for clean test runs
- Comprehensive scenario coverage

---

## Technical Details

### Architecture Changes

**No breaking changes** - all improvements are internal bug fixes and enhancements.

**Modified Files**:
- `src/index.ts` - Root-level file filtering, PR title generation
- `src/file-processor.ts` - Subsection duplication fix
- `scripts/test-action-on-github.sh` - New GitHub test infrastructure
- `docs/` - Documentation updates

**New Files**:
- `scripts/test-action-on-github.sh` - Automated GitHub testing
- `docs/presentations/` - Action presentation slides
- `docs/TEST-REPOSITORIES.md` - Test repository guide

**Test Suite Growth**:
- v0.4.3: 87 tests
- v0.4.4: 121 tests (+34 tests, +39% coverage)

---

## Migration Guide

### From v0.4.3

No changes required! v0.4.4 is a drop-in replacement.

**What You Get**:
- ‚úÖ Better PR titles automatically
- ‚úÖ Root-level files now work (if using `docs-folder: '.'`)
- ‚úÖ No subsection duplication
- ‚úÖ More robust error handling

**Configuration Changes** (optional):
```yaml
# If you want to use root-level files:
docs-folder: '.'  # or leave blank for default 'lectures/'

# If you need cross-repo PRs:
github-token: ${{ secrets.QUANTECON_SERVICES_PAT }}  # Not just GITHUB_TOKEN
```

---

## What's Next

### v1.0 - API Stabilization

**Goals**:
- Freeze public interfaces
- Guarantee backward compatibility
- Production validation with QuantEcon lectures
- Performance benchmarks

See [TODO.md](../TODO.md) for detailed roadmap.

---

## Contributors

Special thanks to:
- Testing infrastructure development
- Root-level file support debugging
- Documentation improvements
- Subsection duplication discovery and fix

---

## Release Statistics

**Commits Since v0.4.3**: 19 commits
**Code Changes**: 
- Test coverage: +39% (87 ‚Üí 121 tests)
- Documentation: +5 new docs
- Bug fixes: 4 critical issues

**Development Period**: October 18-24, 2025 (6 days)

---

## Related Links

- [v0.4.3 Release Notes](v0.4.3.md) - Subsection support foundation
- [IMPLEMENTATION.md](../IMPLEMENTATION.md) - Technical implementation guide
- [TESTING.md](../TESTING.md) - Testing guide and philosophy
- [GitHub Repository](https://github.com/quantecon/action-translation-sync)

---

**Last Updated**: October 24, 2025
