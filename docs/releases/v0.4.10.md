# Release v0.4.10 - Parser Unification Fix

**Date**: October 24, 2025  
**Type**: Critical Bug Fix  
**Status**: Production-Ready ✅

---

## Summary

Critical fix for heading-map preservation of deeply nested subsections (#### and beyond). The issue was caused by duplicate parsing logic: `parseDocumentComponents()` used a simple 2-level parser (handling only ## and ###), while `parseSections()` had full recursive support for all levels (##-######). This duplication caused #### subsections to be lost when building heading-maps.

**Solution**: Refactored `parseDocumentComponents()` to call `parseSections()` internally, eliminating the duplicate parsing logic and ensuring all nesting levels are properly handled.

---

## The Problem

### Symptoms

Heading-map entries for #### subsections were being deleted during translation:

```yaml
# Expected (7 entries including #### subsection):
heading-map:
  Vector Spaces: "向量空间"
  Vector Spaces::Basic Properties: "基本性质"
  Vector Spaces::Basic Properties::Applications in Economics: "在经济学中的应用"  # ← This was missing!

# Actual (6 entries):
heading-map:
  Vector Spaces: "向量空间"
  Vector Spaces::Basic Properties: "基本性质"
  # Missing: Applications in Economics
```

### Root Cause

Two different parsers with different capabilities:

1. **`parseSections()`** (lines 18-145): Stack-based recursive parser handling all levels (##-######)
2. **`parseDocumentComponents()`** (lines 218-278): Custom 2-level parser handling only ## and ###

When `parseDocumentComponents()` encountered a #### subsection like:

```markdown
## Vector Spaces

### Basic Properties

#### Applications in Economics

This section discusses...
```

It treated "#### Applications in Economics" as **content** of the ### section, not as a **subsection**. This caused the subsection array to be empty (`subsections.length = 0`), preventing it from being added to the heading-map.

---

## The Solution

### Implementation

Refactored `parseDocumentComponents()` (lines 218-278) to use `parseSections()` internally:

```typescript
// OLD: Custom 2-level parsing with separate loops
// Handled ## sections
// Handled ### subsections within each ##
// Treated #### as content (BUG!)

// NEW: Call parseSections() and extract components
async parseDocumentComponents(content: string, filepath: string): Promise<DocumentComponents> {
  const parsed = await this.parseSections(content, filepath);
  
  // Extract config from lines before title
  // Extract title (# heading)
  // Extract intro (content before first ##)
  // Use parsed.sections directly (includes full recursive structure)
  
  return { config, title, intro, sections: parsed.sections };
}
```

### Benefits

1. **No Duplication**: Single source of truth for parsing logic
2. **DRY Principle**: Code reuse eliminates divergence
3. **Full Recursion**: Automatic support for all nesting levels
4. **Maintainability**: Changes to parsing logic only needed in one place
5. **Correctness**: Subsections at all depths now properly tracked

---

## Verification

### Test Results

All **140 tests pass** ✅

Key test coverage:
- 15 parser tests (recursive structure)
- 24 diff-detector tests (including 6 nested subsection tests)
- 54 file-processor tests (reconstruction)
- 28 heading-map tests (recursive updates)
- 9 integration tests
- 1 e2e fixture test

### Production Verification

**PR #273** shows correct behavior:
- Heading-map has **7 entries** (was 6)
- Includes `Vector Spaces::Basic Properties::Applications in Economics: 在经济学中的应用`
- Document structure preserved correctly:
  ```
  ## 向量空间 (1 subsection)
    → ### 基本性质 (1 subsection)
      → #### 在经济学中的应用 (0 subsections)
  ```

---

## Technical Details

### Files Modified

1. **src/parser.ts** (lines 218-278):
   - Refactored `parseDocumentComponents()` to call `parseSections()`
   - Removed duplicate 2-level parsing logic
   - Now extracts components from recursive parser result

### Code Changes

**Before** (2-level custom parser):
```typescript
// Separate loops for ## and ###
for (const line of lines) {
  if (/^## /.test(line)) {
    // Handle ## section
    for (const subLine of remainingLines) {
      if (/^### /.test(subLine)) {
        // Handle ### subsection
        // #### treated as content (BUG!)
      }
    }
  }
}
```

**After** (unified recursive parser):
```typescript
// Single call to recursive parser
const parsed = await this.parseSections(content, filepath);
// Extract config, title, intro from parsed result
// Use parsed.sections (full recursive structure)
```

### Debug Process

The bug was discovered through extensive DEBUG logging across 8+ iterations:

1. **Initial suspicion**: Merge logic dropping subsections
2. **Investigation**: Validation logic not matching structures
3. **Deeper dive**: Heading-map extraction missing entries
4. **Breakthrough**: `[DEBUG-BEFORE-LOOP]` showed `subsections.length = 0` before merge even started
5. **Root cause**: Parser returning different structures depending on which function was called

Key insight: The structure shown in parser logs (`parseSections()`) was different from what `parseDocumentComponents()` returned.

---

## Impact

### Breaking Changes

None - this is a pure bug fix maintaining API compatibility.

### Migration Notes

No migration needed - existing documents will now have complete heading-maps including all nested subsections.

### Performance

- Test suite runs in ~3s (was ~4s with DEBUG logging)
- No runtime performance impact
- Bundle size unchanged

---

## Lessons Learned

1. **DRY Principle Critical**: Duplicate parsing logic led to divergence and bugs
2. **Test Coverage**: Unit tests passed because they used consistent parser, but production used different code path
3. **Extensive Logging Essential**: DEBUG logging at multiple points revealed the discrepancy
4. **Object References Deceiving**: Seeing structure in logs doesn't mean all code paths see it
5. **Parser Unification**: Having a single recursive parser eliminates entire class of bugs

---

## Next Steps

### v0.5.0 Planning

Now that parser is unified, next priorities:
1. Add automated regression tests for ####, #####, ###### handling
2. Consider performance optimization for large documents
3. Explore caching parsed structures
4. Review other potential code duplication

### Documentation Updates

- ✅ Updated STATUS-REPORT.md
- ✅ Created release note v0.4.10.md
- ⏭️ Consider updating ARCHITECTURE.md with parser unification explanation
- ⏭️ Update README.md if needed

---

## Acknowledgments

**Testing**: Verified in PR #273 with real document containing #### subsections  
**Debug Tooling**: Extensive console.log statements across 8 debugging iterations  
**Test Coverage**: 140 tests provided confidence during refactoring

---

**Version**: 0.4.10  
**Commit**: 26fcc68 (build), 20884a6 (cleanup), f6119f7 (parser fix)  
**Release**: https://github.com/QuantEcon/action-translation-sync/releases/tag/v0.4.10  
**Tag**: v0.4.10 (c735e98)
